generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserMode {
  LANDLORD
  TENANT
}

enum LeaseType {
  LONG_TERM
  SHORT_TERM
  STUDENT
  COLOCATION
}

enum GuarantorType {
  FAMILY
  THIRD_PARTY
  VISALE
  LEGAL_ENTITY
  CAUTIONNER
  GARANTME
}

enum GuarantorStatus {
  CDI
  CDD
  RETIRED
  STUDENT
  UNEMPLOYED
  OTHER
}

enum IncomeType {
  RENTAL
  ALIMONY
  SCHOLARSHIP
  SOCIAL_AID
  OTHER
}

enum Plan {
  FREE
  PLUS
  PRO
}

model User {
  id             String    @id @default(uuid())
  name           String?
  email          String?   @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  favoriteIds    String[]
  
  // Explicit Identity
  firstName      String?
  lastName       String?

  // Coridor Fields
  userMode          UserMode  @default(TENANT)
  plan              Plan      @default(FREE)
  phoneNumber       String?
  birthDate         DateTime?
  birthPlace        String?
  address           String?
  addressLine1      String?
  building          String?
  apartment         String?
  city              String?
  zipCode           String?
  country           String?
  measurementSystem String?   @default("metric") // "metric" or "imperial"

  accounts     Account[]
  // listings     Listing[] // REMOVED in 3-Tier Refactor
  properties   Property[]

  wishlists    Wishlist[]

  tenantProfile TenantProfile?

  conversations Conversation[]
  seenMessages  Message[]      @relation("Seen")

  messages      Message[]
  visits        Visit[] // Visits as candidate
  createdScopes TenantCandidateScope[] @relation("CreatedScope")

  // Contacts System
  uniqueCode String? @unique
  contacts   User[]  @relation("UserContacts")
  contactOf  User[]  @relation("UserContacts")
  commuteLocations CommuteLocation[] // NEW: Relation to commute locations
  likes            Like[]
  visitSlots       VisitSlot[]   // Availability linked to User + Location
  bankConnections  BankConnection[] // NEW: Banking Connectivity
}

model TenantProfile {
  id        String  @id @default(uuid())
  userId    String  @unique
  jobType   String?
  jobTitle  String?
  netSalary Int?

  // Partner Info
  partnerJobType   String?
  partnerJobTitle  String?
  partnerNetSalary Int?

  // APL Info
  aplAmount        Int?
  aplDirectPayment Boolean @default(false)

  // Rent Verification (GoCardless)
  rentVerified       Boolean @default(false)
  detectedRentAmount Int?
  rentPaymentDate    Int? // Day of the month (1-31)

  // Bio
  bio               String?

  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  guarantors        Guarantor[]
  additionalIncomes Income[]
}

model Guarantor {
  id              String          @id @default(uuid())
  tenantProfileId String
  type            GuarantorType
  status          GuarantorStatus
  netIncome       Int

  tenantProfile     TenantProfile @relation(fields: [tenantProfileId], references: [id], onDelete: Cascade)
  additionalIncomes Income[]
}

model Income {
  id     String     @id @default(uuid())
  type   IncomeType
  amount Int

  tenantProfileId String?
  tenantProfile   TenantProfile? @relation(fields: [tenantProfileId], references: [id], onDelete: Cascade)

  guarantorId String?
  guarantor   Guarantor? @relation(fields: [guarantorId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Property {
  id              String   @id @default(uuid())
  ownerId         String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Physical Characteristics
  category        String   // Apartment, House, etc.
  constructionYear Int?
  constructionPeriod String? // e.g. "Avant 1948", "1949 - 1974"
  totalSurface    Float?   // Surface totale du bien
  purchasePrice   Int?     // Prix d'achat (Euros)
  
  // Location
  address         String?  // Full address string
  addressLine1    String?
  building        String?
  apartment       String? // Complement d'adresse
  city            String?
  zipCode         String?
  country         String?
  latitude        Float?
  longitude       Float?
  district        String?
  neighborhood    String?
  
  // Global Amenities (Building/Property context)
  isNearTransport   Boolean @default(false)
  isNearShops       Boolean @default(false)
  isNearSchools     Boolean @default(false)
  isNearGreenSpace  Boolean @default(false)
  isNearHospital    Boolean @default(false)
  isQuietArea       Boolean @default(false)
  
  hasSeparateKitchen Boolean @default(false) // NEW field
  hasSofteners      Boolean @default(false) // Adoucisseur
  hasFiber          Boolean @default(false)
  hasBikeRoom       Boolean @default(false)
  hasElevator       Boolean @default(false)
  isAccessible      Boolean @default(false) // PMR
  hasDigicode       Boolean @default(false)
  hasIntercom       Boolean @default(false)
  hasCaretaker      Boolean @default(false)
  hasPool           Boolean @default(false)
  
  // Energy Performance
  dpe             String?
  ges             String?
  dpe_year        Int?
  energy_cost_min Int?
  energy_cost_max Int?
  heatingSystem   String?
  glazingType     String?
  
  // Physical Characteristics (Moved from RentalUnit)
  totalFloors     Int?
  floor           Int? // Floor of the property
  
  isTraversant      Boolean @default(false)
  isSouthFacing     Boolean @default(false)
  isBright          Boolean @default(false)
  hasGarden         Boolean @default(false)
  hasBalcony        Boolean @default(false)
  hasView           Boolean @default(false)
  hasAirConditioning Boolean @default(false)
  hasBathtub        Boolean @default(false)
  isRefurbished     Boolean @default(false)
  isQuiet           Boolean @default(false)
  hasNoOpposite     Boolean @default(false)
  
  // Relations
  owner           User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  rentalUnits     RentalUnit[]
  rooms           Room[]        // Physical rooms (Salon, Cuisine, etc.)
  images          PropertyImage[] // Common Area images

  
  // Caching/Transit
  transitData     Json?

  expenses              Expense[]
  reconciliationHistory ReconciliationHistory[]

  @@index([ownerId])
}

enum RentalUnitType {
  ENTIRE_PLACE
  PRIVATE_ROOM
  SHARED_ROOM
}

model RentalUnit {
  id          String         @id @default(uuid())
  propertyId  String
  name        String         // "Appartement Entier" or "Chambre 1"
  type        RentalUnitType
  isActive    Boolean        @default(true)
  
  // Specific Characteristics
  surface     Float?
  bedType     String? // "SINGLE", "DOUBLE", "NONE"
  
  // Amenities specific to this unit
  isFurnished       Boolean @default(false)
  hasPrivateBathroom Boolean @default(false)
  
  // Room Link (for Colocation/Private Room)
  targetRoomId      String?  // If this unit corresponds to a specific physical room
  targetRoom        Room?    @relation(fields: [targetRoomId], references: [id])
  
  property    Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  listings    Listing[]
  images      PropertyImage[] // Unit specific images
  expenses    Expense[]
}

model Listing {
  id            String   @id @default(uuid())
  rentalUnitId  String
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  statusUpdatedAt DateTime @default(now())
  
  // Commercial Offer
  price         Int      // Loyer hors charges
  charges       Json?    // { amount: 100, included: true/false }
  securityDeposit Int?
  
  isPublished   Boolean  @default(false)
  status        String   @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  
  availableFrom DateTime?
  
  // Marketing
  title         String
  description   String
  propertyAdjective String? // "Lumineux", "Spacieux"
  
  // Target Constraints
  roomCount     Int?     // Overrides unit room count if necessary
  bathroomCount Int?
  guestCount    Int?
  
  isStudentFriendly Boolean @default(false)
  petsAllowed       Boolean @default(false)
  
  leaseType     LeaseType?
  
  // Relations
  rentalUnit    RentalUnit @relation(fields: [rentalUnitId], references: [id], onDelete: Cascade)
  
  // User Interactions (Commercial Links)

  wishlists     Wishlist[]
  conversations Conversation[]
  visits        Visit[]
  applications  RentalApplication[]
  messages      Message[]
  likes         Like[]
  
  // Furniture Inventory (Commercial/Legal)
  furniture     Furniture?
  
  // Legacy User Link (Can be inferred via Property, but useful for fast access/queries)
  // userId        String
  // user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([rentalUnitId])
}

model Furniture {
  id        String  @id @default(uuid())
  listingId String  @unique
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  // Mandatory (Meublé)
  bedding  Boolean @default(false)
  curtains Boolean @default(false)
  hob      Boolean @default(false)
  oven     Boolean @default(false)
  fridge   Boolean @default(false)
  freezer  Boolean @default(false)
  dishes   Boolean @default(false)
  utensils Boolean @default(false)
  table    Boolean @default(false)
  seats    Boolean @default(false)
  shelves  Boolean @default(false)
  lights   Boolean @default(false)
  vacuum   Boolean @default(false)

  // Optional
  washingMachine Boolean @default(false)
  coffeeMaker    Boolean @default(false)
  toaster        Boolean @default(false)
  dishwasher     Boolean @default(false)
  hairDryer      Boolean @default(false)
  mirror         Boolean @default(false)
  sheets         Boolean @default(false)
  towels         Boolean @default(false)
  cloths         Boolean @default(false)
}

model VisitSlot {
  id          String   @id @default(uuid())
  userId      String   // Availability is linked to User
  
  date        DateTime
  startTime   String
  endTime     String
  
  // Location of the Landlord's presence
  latitude    Float
  longitude   Float
  address     String?
  radius      Int      @default(200) // Match radius in meters

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum VisitStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

model Visit {
  id          String      @id @default(uuid())
  listingId   String      // REMAINS: Candidate visits a specific Listing offer
  candidateId String
  date        DateTime
  startTime   String
  endTime     String
  status      VisitStatus @default(PENDING)
  createdAt   DateTime    @default(now())

  listing     Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  candidate   User    @relation(fields: [candidateId], references: [id], onDelete: Cascade)
}

model Room {
  id          String   @id @default(uuid())
  name        String
  propertyId  String   // CHANGED: Room belongs to Property
  
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  images      PropertyImage[]
  
  // Reverse relation for RentalUnit logic targeting a specific room
  rentalUnits RentalUnit[]
}

model PropertyImage {
  id           String  @id @default(uuid())
  url          String
  order        Int     @default(0)
  
  // Can belong to Property (Common areas) OR RentalUnit (Private areas)
  propertyId   String?
  rentalUnitId String?
  roomId       String?
  
  property     Property?   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  rentalUnit   RentalUnit? @relation(fields: [rentalUnitId], references: [id], onDelete: Cascade)
  room         Room?       @relation(fields: [roomId], references: [id])
}



model Wishlist {
  id        String   @id @default(uuid())
  userId    String
  name      String
  createdAt DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  listings Listing[]
}

model Conversation {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  lastMessageAt DateTime @default(now())
  name          String?
  isGroup       Boolean?

  messagesIds String[]
  messages    Message[]

  users User[]

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id])
}

model Message {
  id        String   @id @default(uuid())
  body      String?
  image     String?
  createdAt DateTime @default(now())

  seenIds String[]
  seen    User[]   @relation("Seen")

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation(fields: [senderId], references: [id], onDelete: Cascade)

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id])
}

// model Amenity {
//   id        String                                @id @default(uuid())
//   type      String
//   latitude  Float
//   longitude Float
//   name      String?
//   city      String?
//   zipCode   String?
//   sourceId  String?                               @unique
//   geom      Unsupported("geometry(Point, 4326)")?
//   createdAt DateTime                              @default(now())
//   updatedAt DateTime                              @updatedAt
//
//   @@index([geom], name: "amenity_geom_idx", type: Gist)
// }

enum CompositionType {
  SOLO
  COUPLE
  GROUP
}

enum CoupleLegalStatus {
  NONE
  MARRIED
  PACS
  CONCUBINAGE
}

enum TargetLeaseType {
  ANY
  FURNISHED
  EMPTY
  MOBILITY
}

model TenantCandidateScope {
  id                String             @id @default(uuid())
  creatorUserId     String
  compositionType   CompositionType
  membersIds        String[]
  coupleLegalStatus CoupleLegalStatus?
  targetLeaseType   TargetLeaseType
  childCount        Int                @default(0)
  targetMoveInDate  DateTime?
  createdAt         DateTime           @default(now())

  creatorUser  User                @relation("CreatedScope", fields: [creatorUserId], references: [id], onDelete: Cascade)
  applications RentalApplication[]
}

enum ApplicationStatus {
  PENDING
  SENT
  REJECTED
  VISIT_PROPOSED
  VISIT_CONFIRMED
  ACCEPTED
}

enum LeaseStatus {
  DRAFT
  PENDING_SIGNATURE
  SIGNED
}

enum SpecificLeaseRequest {
  DEFAULT
  STUDENT
  MOBILITY
}

model RentalApplication {
  id                   String               @id @default(uuid())
  listingId            String
  candidateScopeId     String
  status               ApplicationStatus    @default(SENT)
  specificLeaseRequest SpecificLeaseRequest @default(DEFAULT)
  appliedAt            DateTime             @default(now())

  // Lease & Signature
  leaseStatus        LeaseStatus @default(DRAFT)
  yousignSignatureId String? // Signature Request ID
  signedLeaseUrl     String? // URL of final signed PDF

  // Lease Indexation
  indexationQuarter  Int?    // 1, 2, 3, or 4
  baseIndexValue     Float?  // Index value at lease signature


  listing        Listing              @relation(fields: [listingId], references: [id], onDelete: Cascade)
  candidateScope TenantCandidateScope @relation(fields: [candidateScopeId], references: [id], onDelete: Cascade)
  
  reconciliationHistory ReconciliationHistory[]
  
  // Financial History
  financials         LeaseFinancials[]
  matchedTransactions BankTransaction[]
}

model LeaseFinancials {
  id                   String   @id @default(uuid())
  rentalApplicationId  String
  
  baseRentCents        Int      // Loyer hors charges
  serviceChargesCents  Int      // Provision sur charges
  
  startDate            DateTime @db.Date // Date d'entrée en vigueur
  endDate              DateTime? @db.Date // Date de fin (null = actif)

  createdAt            DateTime @default(now())

  rentalApplication    RentalApplication @relation(fields: [rentalApplicationId], references: [id], onDelete: Cascade)
}

// NEW: Commute Location Model
model CommuteLocation {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String   // e.g., "Travail", "École"
  address       String
  latitude      Float
  longitude     Float
  transportMode String   @default("TRANSIT") // TRANSIT, DRIVING, CYCLING, WALKING
  icon          String?  // NEW: Icon name (e.g., 'briefcase', 'home')
  isShowOnMap   Boolean  @default(true) // NEW: Toggle visibility on map
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  listingId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
}

// EXPENSES & RECONCILIATION

enum ExpenseCategory {
  COLD_WATER
  HOT_WATER
  ELECTRICITY_COMMON
  ELECTRICITY_PRIVATE
  HEATING_COLLECTIVE
  TAX_PROPERTY
  ELEVATOR
  INSURANCE
  MAINTENANCE
  CARETAKER
  OTHER
  METERS
  GENERAL_CHARGES
  BUILDING_CHARGES
  PARKING
  INSURANCE_GLI
}

enum ExpenseFrequency {
  ONCE
  MONTHLY
  QUARTERLY
  YEARLY
}

model Expense {
  id                     String           @id @default(uuid())
  propertyId             String
  rentalUnitId           String?
  category               ExpenseCategory
  label                  String
  amountTotalCents       Int
  dateOccurred           DateTime         @db.Date
  frequency              ExpenseFrequency
  isRecoverable          Boolean
  recoverableRatio       Float            @default(1.0)
  proofUrl               String?
  isFinalized            Boolean          @default(false)
  amountRecoverableCents Int?             // Computed or manually set? Image doesn't specify logic, just field.
  amountDeductibleCents  Int?             // NEW: Montant déductible des impôts

  property               Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  rentalUnit             RentalUnit?      @relation(fields: [rentalUnitId], references: [id])
  
  reconciliationItems    ReconciliationItem[]
}

model ReconciliationHistory {
  id                    String   @id @default(uuid())
  propertyId            String
  leaseId               String   // Linked to RentalApplication (Lease)
  
  periodStart           DateTime @db.Date
  periodEnd             DateTime @db.Date
  
  totalRealChargesCents Int
  totalProvisionsCents  Int
  finalBalanceCents     Int      // Debiteur or Crediteur
  
  reportUrl             String?
  createdAt             DateTime @default(now())

  property              Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  lease                 RentalApplication @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  
  items                 ReconciliationItem[]
}

model ReconciliationItem {
  reconciliationId String
  expenseId        String

  reconciliation   ReconciliationHistory @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  expense          Expense               @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@id([reconciliationId, expenseId])
}
model RentIndex {
  id          String   @id @default(uuid())
  quarter     Int
  year        Int
  value       Float
  publishedAt DateTime

  @@unique([year, quarter])
}
// BANKING CONNECTIVITY
model BankConnection {
  id           String   @id @default(uuid())
  userId       String
  provider     String   @default("POWENS")
  connectionId String?  // Powens External ID
  
  accessToken  String?  @db.Text
  refreshToken String?  @db.Text
  tokenExpiresAt DateTime?

  lastSyncedAt DateTime?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions BankTransaction[]
  
  @@unique([userId, connectionId]) 
}

model BankTransaction {
  id               String   @id @default(uuid())
  bankConnectionId String
  remoteId         String   // Powens Transaction ID
  
  date             DateTime
  label            String   // Wording
  amount           Float    // Positive = Credit, Negative = Debit
  currency         String   @default("EUR")
  
  category         String?  // Powens Category
  
  isProcessed      Boolean  @default(false)
  
  // Link to Lease if we matched it (Rent Payment)
  matchedLeaseId   String?
  matchedLease     RentalApplication? @relation(fields: [matchedLeaseId], references: [id])
  
  createdAt        DateTime @default(now())

  bankConnection   BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
  
  @@unique([bankConnectionId, remoteId])
}
